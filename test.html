<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Điều hướng Giao hàng - Delivery Navigation</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        /* Container chính */
        .nav-app-container {
            position: relative;
            height: 100vh;
            width: 100%;
            overflow: hidden;
            background-color: #f8fafc;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: #1e293b;
        }

        /* Map container */
        .nav-map-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
        }

        /* Loading overlay */
        .nav-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .nav-loading-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            display: flex;
            align-items: center;
            gap: 12px;
            color: #1e293b;
        }

        .nav-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #0ea5e9;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: nav-spin 1s linear infinite;
        }

        @keyframes nav-spin {
            to { transform: rotate(360deg); }
        }

        /* Search bar */
        .nav-search-container {
            position: absolute;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 448px;
            padding: 0 16px;
            z-index: 40;
        }

        .nav-search-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: box-shadow 0.2s ease;
            border: 1px solid #e2e8f0;
        }

        .nav-search-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .nav-search-content {
            display: flex;
            align-items: center;
            padding: 16px;
        }

        .nav-search-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            color: #64748b;
        }

        .nav-search-placeholder {
            color: #64748b;
            font-size: 16px;
        }

        /* Search input panel */
        .nav-search-panel {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 1px solid #e2e8f0;
        }

        .nav-search-input-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-search-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            background-color: white;
            color: #1e293b;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .nav-search-input:focus {
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .nav-btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn-primary {
            background-color: #0ea5e9;
            color: white;
        }

        .nav-btn-primary:hover {
            background-color: #0284c7;
        }

        .nav-btn-outline {
            background-color: transparent;
            color: #475569;
            border: 2px solid #e2e8f0;
        }

        .nav-btn-outline:hover {
            background-color: #f8fafc;
            border-color: #cbd5e1;
        }

        .nav-btn-icon {
            width: 16px;
            height: 16px;
        }

        /* Search results */
        .nav-results-container {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 448px;
            padding: 0 16px;
            z-index: 40;
        }

        .nav-results-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-height: 320px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
        }

        .nav-results-header {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            font-size: 18px;
        }

        .nav-result-item {
            padding: 16px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .nav-result-item:hover {
            background-color: #f8fafc;
        }

        .nav-result-item:last-child {
            border-bottom: none;
        }

        .nav-result-name {
            font-weight: 500;
            color: #0ea5e9;
            margin-bottom: 4px;
        }

        .nav-result-address {
            font-size: 14px;
            color: #64748b;
        }

        .nav-results-close {
            padding: 16px;
        }

        /* Delivery status indicator */
        .nav-delivery-status {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 40;
        }

        .nav-status-badge {
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-status-idle {
            color: #059669;
            border-color: #10b981;
        }

        .nav-status-active {
            color: #dc2626;
            border-color: #ef4444;
        }

        .nav-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: nav-pulse-dot 2s infinite;
        }

        .nav-status-idle .nav-status-dot {
            background-color: #10b981;
        }

        .nav-status-active .nav-status-dot {
            background-color: #ef4444;
        }

        @keyframes nav-pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Navigation info */
        .nav-info-container {
            position: absolute;
            top: 16px;
            left: 0;
            width: 100%;
            max-width: 320px;
            padding: 0 16px;
            z-index: 30;
        }

        .nav-info-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-left: 4px solid #0ea5e9;
            backdrop-filter: blur(8px);
        }

        .nav-info-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .nav-info-icon {
            width: 48px;
            height: 48px;
            color: #0ea5e9;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            background: rgba(14, 165, 233, 0.1);
            border-radius: 50%;
        }

        .nav-info-details {
            flex: 1;
        }

        .nav-info-distance {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
            color: #1e293b;
        }

        .nav-info-street {
            font-size: 16px;
            color: #64748b;
        }

        .nav-info-speed {
            text-align: center;
            background: #1e293b;
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .nav-speed-value {
            font-size: 18px;
            font-weight: 700;
        }

        .nav-speed-unit {
            font-size: 12px;
            color: #94a3b8;
        }

        .nav-warning {
            margin-top: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #fef3c7;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #f59e0b;
        }

        .nav-warning-icon {
            width: 16px;
            height: 16px;
            color: #f59e0b;
        }

        .nav-warning-text {
            font-size: 14px;
            color: #92400e;
        }

        /* Route summary */
        .nav-summary-container {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 448px;
            padding: 0 16px;
            z-index: 30;
        }

        .nav-summary-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .nav-summary-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .nav-destination-name {
            font-weight: 600;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }

        .nav-time-badge {
            background-color: #0ea5e9;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
        }

        .nav-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .nav-stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-stat-icon {
            width: 16px;
            height: 16px;
            color: #64748b;
        }

        .nav-stat-value {
            font-weight: 500;
        }

        .nav-stat-label {
            font-size: 12px;
            color: #64748b;
        }

        .nav-progress-bar {
            height: 6px;
            background-color: #e2e8f0;
            border-radius: 3px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .nav-progress-fill {
            height: 100%;
            background-color: #0ea5e9;
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .nav-delivery-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        .nav-start-btn {
            width: 100%;
            background-color: #0ea5e9;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .nav-start-btn:hover {
            background-color: #0284c7;
        }

        .nav-start-btn:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
        }

        .nav-delivery-btn {
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 14px;
        }

        .nav-pickup-btn {
            background-color: #f59e0b;
            color: white;
        }

        .nav-pickup-btn:hover {
            background-color: #d97706;
        }

        .nav-delivered-btn {
            background-color: #10b981;
            color: white;
        }

        .nav-delivered-btn:hover {
            background-color: #059669;
        }

        /* Map controls */
        .nav-controls {
            position: absolute;
            bottom: 16px;
            right: 16px;
            z-index: 30;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-control-btn {
            width: 48px;
            height: 48px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 24px;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.06), 0 1px 2px -1px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: #475569;
        }

        .nav-control-btn:hover {
            background-color: #f8fafc;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .nav-control-icon {
            width: 20px;
            height: 20px;
        }

        /* Accuracy indicator */
        .nav-accuracy {
            position: absolute;
            bottom: 16px;
            left: 16px;
            z-index: 30;
        }

        .nav-accuracy-badge {
            background: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.06), 0 1px 2px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
        }

        .nav-accuracy-good { color: #059669; }
        .nav-accuracy-medium { color: #d97706; }
        .nav-accuracy-poor { color: #dc2626; }

        /* Hidden class */
        .nav-hidden {
            display: none !important;
        }

        /* Custom marker styles */
        .nav-current-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #06b6d4; /* Đổi thành xanh nước biển */
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            position: relative;
        }

        /* Triangle marker for navigation - Fixed design */
        .nav-triangle-marker {
            width: 24px;
            height: 24px;
            position: relative;
            transform-origin: center center;
        }

        .nav-triangle-marker::before {
            content: "";
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 20px solid #0ea5e9;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .nav-triangle-marker::after {
            content: "";
            position: absolute;
            top: 3px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 14px solid white;
        }

        /* Wave animation for stationary position - 2km radius */
        @keyframes nav-wave {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(8);
                opacity: 0;
            }
        }

        .nav-wave-ring {
            position: absolute;
            top: -3%;
            left: -4%;
            width: 20px;
            height: 20px;
            border: 2px solid #06b6d4; /* Đổi từ #0ea5e9 thành #06b6d4 (cyan-500) */
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: nav-wave 4s ease-out infinite;
        }

        .nav-wave-ring:nth-child(2) {
            animation-delay: 1.3s;
        }

        .nav-wave-ring:nth-child(3) {
            animation-delay: 2.6s;
        }

        /* Responsive design */
        @media (max-width: 640px) {
            .nav-search-container,
            .nav-results-container,
            .nav-info-container,
            .nav-summary-container {
                max-width: calc(100% - 32px);
            }
            
            .nav-stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .nav-delivery-actions {
                grid-template-columns: 1fr;
            }
        }

        /* Map mode toggle - Redesigned */
        .nav-mode-toggle {
            position: fixed;
            bottom: 100px;
            right: 16px;
            z-index: 1000;
        }

        .nav-mode-switch {
            background: #0ea5e9;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border: 3px solid white;
            cursor: pointer;
            animation: nav-float 2s infinite alternate;
        }
        
        @keyframes nav-float {
            0% { transform: translateY(0); }
            100% { transform: translateY(-10px); }
        }

        .nav-mode-icon {
            width: 32px;
            height: 32px;
            color: white;
        }

        /* Mode Selection Panel */
        .nav-mode-selector-panel {
            position: fixed;
            bottom: 170px;
            right: 16px;
            z-index: 1000;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 200px;
        }

        .nav-mode-selector-panel-header {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 12px;
            color: #1e293b;
        }

        .nav-mode-selector-panel-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-mode-selector-panel-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            background-color: #0ea5e9;
            color: white;
        }

        .nav-mode-selector-panel-option:hover {
            background-color: #0284c7;
        }

        .nav-mode-selector-panel-option-text {
            font-weight: 500;
        }

        /* Delivery mode specific */
        .delivery-mode-element {
            display: flex;
        }
        
        /* Navigation mode specific */
        .navigation-mode-element {
            display: none;
        }
        
        /* When in navigation mode */
        body.navigation-mode .delivery-mode-element {
            display: none;
        }
        
        body.navigation-mode .navigation-mode-element {
            display: flex;
        }
        
        /* Navigation theme colors */
        body.navigation-mode .nav-info-icon {
            background: rgba(79, 70, 229, 0.1) !important;
        }
        
        body.navigation-mode .nav-triangle-marker::before {
            border-bottom-color: #4f46e5 !important;
        }
        
        body.navigation-mode .nav-current-marker {
            background-color: #4f46e5 !important;
        }
        
        body.navigation-mode .nav-wave-ring {
            border-color: #4f46e5 !important;
        }
        
        body.navigation-mode .nav-status-active {
            color: #4f46e5 !important;
            border-color: #4f46e5 !important;
        }
        
        body.navigation-mode .nav-status-active .nav-status-dot {
            background-color: #4f46e5 !important;
        }
        
        body.navigation-mode #route {
            line-color: #4f46e5 !important;
        }
        
        body.navigation-mode #route-casing {
            line-color: #6366f1 !important;
        }

        /* Navigation instruction panel */
        .nav-instruction-panel {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: 448px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            z-index: 40;
        }
        
        .nav-instruction-header {
            background-color: #4f46e5;
            color: white;
            padding: 12px 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .nav-instruction-distance {
            font-size: 16px;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 16px;
        }
        
        .nav-instruction-body {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .nav-instruction-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f1f5f9;
            border-radius: 50%;
        }
        
        .nav-instruction-details {
            flex: 1;
        }
        
        .nav-instruction-text {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .nav-instruction-street {
            color: #64748b;
            font-size: 14px;
        }
        
        .nav-instruction-next {
            border-top: 1px solid #e2e8f0;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            background-color: #f8fafc;
        }
        
        .nav-instruction-next-icon {
            width: 24px;
            height: 24px;
            background-color: #e2e8f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .nav-instruction-next-text {
            font-size: 14px;
            color: #64748b;
        }
    </style>
</head>
<body>
    <div class="nav-app-container">
        <!-- Map Container -->
        <div id="navMap" class="nav-map-container"></div>

        <!-- Loading Overlay -->
        <div id="navLoading" class="nav-loading-overlay nav-hidden">
            <div class="nav-loading-card">
                <div class="nav-spinner"></div>
                <span>Đang tải...</span>
            </div>
        </div>

        <!-- Delivery Status -->
        <div class="nav-delivery-status">
            <div id="navStatusBadge" class="nav-status-badge nav-status-idle">
                <div class="nav-status-dot"></div>
                <span id="navStatusText">Sẵn sàng giao hàng</span>
            </div>
        </div>

        <!-- Mode Indicator Banner -->
        <div id="modeIndicator" class="nav-hidden" style="position: absolute; top: 0; left: 0; right: 0; padding: 10px; text-align: center; font-weight: 600; z-index: 40; transition: all 0.3s ease;">
            <div id="deliveryIndicator" class="delivery-mode-element" style="background-color: rgba(6, 182, 212, 0.9); color: white; padding: 8px; border-radius: 0 0 12px 12px; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
                    <path d="M19 7c0-1.1-.9-2-2-2h-3v2h3v2.65L13.52 14H10V9H6c-2.21 0-4 1.79-4 4v3h2c0 1.66 1.34 3 3 3s3-1.34 3-3h4.48L19 10.35V7zM7 17c-.55 0-1-.45-1-1h2c0 .55-.45 1-1 1z"/>
                </svg>
                CHẾ ĐỘ GIAO HÀNG
            </div>
            <div id="navigationIndicator" class="navigation-mode-element" style="background-color: rgba(79, 70, 229, 0.9); color: white; padding: 8px; border-radius: 0 0 12px 12px; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
                    <path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/>
                </svg>
                CHẾ ĐỘ ĐIỀU HƯỚNG
            </div>
        </div>

        <!-- Search Bar -->
        <div class="nav-search-container">
            <div id="navSearchBar" class="nav-search-card" onclick="toggleSearch()">
                <div class="nav-search-content">
                    <svg class="nav-search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <span class="nav-search-placeholder">Tìm địa chỉ giao hàng...</span>
                </div>
            </div>

            <div id="navSearchPanel" class="nav-search-panel nav-hidden">
                <div class="nav-search-input-container">
                    <input type="text" id="navSearchInput" class="nav-search-input" placeholder="Nhập địa chỉ giao hàng..." />
                    <button class="nav-btn nav-btn-primary" onclick="searchDestination()">
                        <svg class="nav-btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </button>
                    <button class="nav-btn nav-btn-outline" onclick="toggleSearch()">
                        <svg class="nav-btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Search Results -->
        <div id="navSearchResults" class="nav-results-container nav-hidden">
            <div class="nav-results-card">
                <div class="nav-results-header">Chọn địa chỉ giao hàng:</div>
                <div id="navResultsList"></div>
                <div class="nav-results-close">
                    <button class="nav-btn nav-btn-outline" style="width: 100%;" onclick="hideSearchResults()">Đóng</button>
                </div>
            </div>
        </div>

        <!-- Navigation Info -->
        <div id="navInfo" class="nav-info-container nav-hidden">
            <div class="nav-info-card">
                <div class="nav-info-content">
                    <div class="nav-info-icon" id="navDirectionIcon">
                        ↑
                    </div>
                    <div class="nav-info-details">
                        <div id="navNextDistance" class="nav-info-distance">-- km</div>
                        <div id="navNextStreet" class="nav-info-street">Đường không tên</div>
                    </div>
                    <div class="nav-info-speed">
                        <div id="navSpeed" class="nav-speed-value">0</div>
                        <div class="nav-speed-unit">km/h</div>
                    </div>
                </div>
                <div id="navWarning" class="nav-warning nav-hidden">
                    <svg class="nav-warning-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2L1 21h22L12 2zm0 3.99L19.53 19H4.47L12 5.99zM11 16h2v2h-2v-2zm0-6h2v4h-2v-4z"/>
                    </svg>
                    <span class="nav-warning-text">Cảnh báo: Độ chính xác GPS thấp!</span>
                </div>
            </div>
        </div>

        <!-- Route Summary -->
        <div id="navSummary" class="nav-summary-container nav-hidden">
            <div class="nav-summary-card">
                <div class="nav-summary-header">
                    <div id="navDestinationName" class="nav-destination-name">Chưa chọn địa chỉ</div>
                    <div id="navTimeBadge" class="nav-time-badge nav-hidden">
                        <svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/>
                            <path d="M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                        </svg>
                        <span id="navTotalTime">-- phút</span>
                    </div>
                </div>

                <div id="navStatsGrid" class="nav-stats-grid nav-hidden">
                    <div class="nav-stat">
                        <svg class="nav-stat-icon" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7"/>
                        </svg>
                        <div>
                            <div id="navTotalDistance" class="nav-stat-value">-- km</div>
                            <div class="nav-stat-label">Khoảng cách</div>
                        </div>
                    </div>
                    <div class="nav-stat">
                        <svg class="nav-stat-icon" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/>
                            <path d="M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                        </svg>
                        <div>
                            <div id="navArrivalTime" class="nav-stat-value">--:--</div>
                            <div class="nav-stat-label">Đến nơi</div>
                        </div>
                    </div>
                </div>

                <div class="nav-progress-bar">
                    <div id="navProgressFill" class="nav-progress-fill"></div>
                </div>

                <div id="navDeliveryActions" class="nav-delivery-actions nav-hidden">
                    <button class="nav-delivery-btn nav-pickup-btn" onclick="markPickedUp()">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
                        </svg>
                        Đã lấy hàng
                    </button>
                    <button class="nav-delivery-btn nav-delivered-btn" onclick="markDelivered()">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        Đã giao
                    </button>
                </div>

                <button id="navStartBtn" class="nav-start-btn nav-hidden" onclick="startDelivery()">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    Bắt đầu giao hàng
                </button>
            </div>
        </div>

        <!-- Map Controls -->
        <div class="nav-controls">
            <button class="nav-control-btn" onclick="goToCurrentLocation()" title="Vị trí hiện tại">
                <svg class="nav-control-icon" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06A8.994 8.994 0 0011 20.94V23h2v-2.06A8.994 8.994 0 0020.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
                </svg>
            </button>
            <button class="nav-control-btn" onclick="zoomIn()" title="Phóng to">
                <svg class="nav-control-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
            </button>
            <button class="nav-control-btn" onclick="zoomOut()" title="Thu nhỏ">
                <svg class="nav-control-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                </svg>
            </button>
            <button class="nav-control-btn" onclick="toggleView()" title="Chuyển đổi góc nhìn">
                <svg class="nav-control-icon" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
            </button>
        </div>

        <!-- Accuracy Indicator -->
        <div id="navAccuracy" class="nav-accuracy nav-hidden">
            <div id="navAccuracyBadge" class="nav-accuracy-badge">
                GPS: ±0m
            </div>
        </div>

        <!-- Mode Toggle - Redesigned -->
        <div class="nav-mode-toggle" onclick="toggleModePanel()">
            <div class="nav-mode-switch">
                <svg class="nav-mode-icon" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
                </svg>
            </div>
        </div>

        <!-- Mode Selection Panel -->
        <div id="modeSelectorPanel" class="nav-hidden" style="position: fixed; bottom: 170px; right: 16px; z-index: 1000; background: white; border-radius: 12px; padding: 16px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); width: 200px;">
            <div style="font-weight: 600; font-size: 16px; margin-bottom: 12px; color: #1e293b;">Chọn chế độ</div>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <div id="deliveryModeOption" style="display: flex; align-items: center; gap: 8px; padding: 10px; border-radius: 8px; cursor: pointer; background-color: #0ea5e9; color: white;" onclick="switchMode('delivery')">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19 7c0-1.1-.9-2-2-2h-3v2h3v2.65L13.52 14H10V9H6c-2.21 0-4 1.79-4 4v3h2c0 1.66 1.34 3 3 3s3-1.34 3-3h4.48L19 10.35V7zM7 17c-.55 0-1-.45-1-1h2c0 .55-.45 1-1 1z"/>
                        <path d="M5 6h5v2H5zm14 7c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3zm0 4c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/>
                    </svg>
                    <span style="font-weight: 500;">Giao hàng</span>
                </div>
                <div id="navigationModeOption" style="display: flex; align-items: center; gap: 8px; padding: 10px; border-radius: 8px; cursor: pointer; background-color: #f1f5f9; color: #64748b;" onclick="switchMode('navigation')">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/>
                    </svg>
                    <span style="font-weight: 500;">Điều hướng</span>
                </div>
            </div>
        </div>

        <!-- Navigation Instruction Panel -->
        <div id="navInstructionPanel" class="nav-instruction-panel nav-hidden">
            <div class="nav-instruction-header">
                <div id="navInstructionAction">Tiếp theo</div>
                <div id="navInstructionDistance" class="nav-instruction-distance">300m</div>
            </div>
            <div class="nav-instruction-body">
                <div class="nav-instruction-icon">
                    <svg id="navInstructionIcon" width="30" height="30" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"/>
                    </svg>
                </div>
                <div class="nav-instruction-details">
                    <div id="navInstructionText" class="nav-instruction-text">Đi thẳng</div>
                    <div id="navInstructionStreet" class="nav-instruction-street">Tên đường tiếp theo</div>
                </div>
            </div>
            <div class="nav-instruction-next">
                <div class="nav-instruction-next-icon">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M14 7l-5 5 5 5V7z"/>
                    </svg>
                </div>
                <div id="navInstructionNextText" class="nav-instruction-next-text">Sau đó rẽ trái vào Tên đường sau đó</div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let map, currentLocation = null, destination = null, routeData = null;
        let currentLocationMarker = null, destinationMarker = null;
        let navigationStarted = false, deliveryStarted = false;
        let watchId = null;
        let userBearing = 0;
        let lastSpeed = 0;
        let currentStep = 0;
        let appMode = 'delivery'; // 'delivery' hoặc 'navigation'
        let voiceEnabled = true;
        let nextStepAnnounced = false;

        // Mapbox access token
        mapboxgl.accessToken = 'pk.eyJ1IjoibmhhdG5ndXllbnF2IiwiYSI6ImNtYjZydDNnZDAwY24ybm9qcTdxcTNocG8ifQ.u7X_0DfN7d52xZ8cGFbWyQ';

        // Initialize map
        function initMap() {
            showLoading();
            
            map = new mapboxgl.Map({
                container: 'navMap',
                style: 'mapbox://styles/mapbox/light-v11',
                center: [105.8542, 21.0285], // Hà Nội
                zoom: 16,
                pitch: 0,
                bearing: 0,
                maxPitch: 60
            });

            map.on('load', () => {
                // Tăng chi tiết hiển thị của bản đồ cho delivery drivers
                map.setMinZoom(14);
                
                // Hiển thị tất cả các đường nhỏ và ngõ ngách
                const style = map.getStyle();
                style.layers.forEach(layer => {
                    if (layer.type === 'line' && layer.id.includes('road')) {
                        map.setLayoutProperty(layer.id, 'visibility', 'visible');
                    }
                });

                // Add route source and layers
                map.addSource('route', {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        properties: {},
                        geometry: { type: 'LineString', coordinates: [] }
                    }
                });

                // Route casing (viền ngoài)
                map.addLayer({
                    id: 'route-casing',
                    type: 'line',
                    source: 'route',
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: {
                        'line-color': '#0ea5e9',
                        'line-width': 8,
                        'line-opacity': 0.6
                    }
                });

                // Route chính
                map.addLayer({
                    id: 'route',
                    type: 'line',
                    source: 'route',
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: {
                        'line-color': '#06b6d4',
                        'line-width': 5,
                        'line-opacity': 0.9
                    }
                });

                // Thêm source cho vòng sóng 2km
                map.addSource('wave-circle', {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        properties: { id: 1 },
                        geometry: {
                            type: 'Point',
                            coordinates: [0, 0]
                        }
                    },
                    generateId: false
                });

                // Layer cho vòng sóng 2km
                map.addLayer({
                    id: 'wave-circle-layer',
                    type: 'circle',
                    source: 'wave-circle',
                    paint: {
                        'circle-radius': {
                            stops: [
                                [10, 0],
                                [22, 200] // 2km radius
                            ],
                            base: 2
                        },
                        'circle-color': 'rgba(6, 182, 212, 0.08)', /* Đổi thành cyan */
                        'circle-stroke-width': 2,
                        'circle-stroke-color': 'rgba(6, 182, 212, 0.3)', /* Đổi thành cyan */
                        'circle-opacity': [
                            'case',
                            ['boolean', ['feature-state', 'show'], false],
                            0.6,
                            0
                        ],
                        'circle-stroke-opacity': [
                            'case',
                            ['boolean', ['feature-state', 'show'], false],
                            0.8,
                            0
                        ]
                    }
                });

                hideLoading();
                getCurrentLocation();
            });
        }

        // Get current location
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert('Trình duyệt không hỗ trợ định vị');
                return;
            }

            showLoading();

            const options = {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 15000
            };

            navigator.geolocation.getCurrentPosition(
                position => {
                    currentLocation = [position.coords.longitude, position.coords.latitude];
                    updateAccuracy(position.coords.accuracy);
                    
                    if (position.coords.heading) {
                        userBearing = position.coords.heading;
                    }
                    
                    addCurrentLocationMarker();
                    updateWaveCircle();
                    
                    map.flyTo({
                        center: currentLocation,
                        zoom: 17
                    });

                    // Start watching position
                    watchId = navigator.geolocation.watchPosition(
                        updateLocation,
                        handleLocationError,
                        options
                    );

                    hideLoading();
                },
                handleLocationError,
                options
            );
        }

        // Update location
        function updateLocation(position) {
            const prevLocation = currentLocation ? [...currentLocation] : null;
            currentLocation = [position.coords.longitude, position.coords.latitude];
            updateAccuracy(position.coords.accuracy);
            
            if (position.coords.speed) {
                lastSpeed = position.coords.speed * 3.6; // m/s to km/h
                updateSpeed(lastSpeed);
            }

            // Cập nhật hướng di chuyển
            if (position.coords.heading) {
                userBearing = position.coords.heading;
            } else if (prevLocation && lastSpeed > 1) {
                userBearing = calculateBearing(
                    prevLocation[1], prevLocation[0],
                    position.coords.latitude, position.coords.longitude
                );
            }

            if (currentLocationMarker) {
                currentLocationMarker.setLngLat(currentLocation);
                
                // Cập nhật hướng cho marker tam giác
                if (navigationStarted) {
                    updateTriangleMarkerRotation();
                }
            }

            // Cập nhật vòng sóng
            updateWaveCircle();

            if (navigationStarted) {
                map.easeTo({
                    center: currentLocation,
                    bearing: userBearing,
                    pitch: 45,
                    duration: 1000
                });
                
                updateNavigationInfo();
                checkStepProgress();
            }
        }

        // Check if driver has progressed to next step
        function checkStepProgress() {
            if (!routeData || !routeData.legs[0] || !routeData.legs[0].steps) return;
            
            const steps = routeData.legs[0].steps;
            if (currentStep < steps.length - 1) {
                const nextStep = steps[currentStep + 1];
                const distanceToNextStep = calculateDistance(
                    currentLocation[1], currentLocation[0],
                    nextStep.maneuver.location[1], nextStep.maneuver.location[0]
                );
                
                // If within 50m of next step, advance
                if (distanceToNextStep < 50) {
                    currentStep++;
                    updateNavigationInfo();
                }
            }
        }

        // Calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // Cập nhật vòng sóng 2km
        function updateWaveCircle() {
            if (!currentLocation || navigationStarted) return;
            
            map.getSource('wave-circle').setData({
                type: 'Feature',
                properties: { id: 1 },
                geometry: {
                    type: 'Point',
                    coordinates: currentLocation
                }
            });
            
            // Hiển thị vòng sóng với ID cụ thể
            map.setFeatureState(
                { source: 'wave-circle', id: 1 },
                { show: true }
            );
        }

        // Ẩn vòng sóng khi bắt đầu điều hướng
        function hideWaveCircle() {
            map.setFeatureState(
                { source: 'wave-circle', id: 1 },
                { show: false }
            );
        }

        // Tính hướng di chuyển giữa hai điểm
        function calculateBearing(startLat, startLng, destLat, destLng) {
            startLat = startLat * Math.PI / 180;
            startLng = startLng * Math.PI / 180;
            destLat = destLat * Math.PI / 180;
            destLng = destLng * Math.PI / 180;

            const y = Math.sin(destLng - startLng) * Math.cos(destLat);
            const x = Math.cos(startLat) * Math.sin(destLat) -
                    Math.sin(startLat) * Math.cos(destLat) * Math.cos(destLng - startLng);
            let bearing = Math.atan2(y, x) * 180 / Math.PI;
            bearing = (bearing + 360) % 360;
            
            return bearing;
        }

        // Handle location error
        function handleLocationError(error) {
            hideLoading();
            let message = 'Lỗi không xác định khi lấy vị trí';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Vui lòng cấp quyền truy cập vị trí';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Thông tin vị trí không khả dụng';
                    break;
                case error.TIMEOUT:
                    message = 'Quá thời gian chờ lấy vị trí';
                    break;
            }
            
            alert(message);
        }

        // Add current location marker
        function addCurrentLocationMarker() {
            if (!currentLocation) return;

            // Always remove existing marker first
            if (currentLocationMarker) {
                currentLocationMarker.remove();
                currentLocationMarker = null;
            }

            if (navigationStarted) {
                addTriangleMarker();
            } else {
                addCircleMarker();
            }
        }

        // Thêm marker hình tròn khi không điều hướng
        function addCircleMarker() {
            const el = document.createElement('div');
            el.className = 'nav-current-marker';
            
            // Thêm các vòng sóng
            for (let i = 0; i < 3; i++) {
                const wave = document.createElement('div');
                wave.className = 'nav-wave-ring';
                el.appendChild(wave);
            }

            currentLocationMarker = new mapboxgl.Marker({
                element: el,
                anchor: 'center'
            })
            .setLngLat(currentLocation)
            .addTo(map);
        }

        // Thêm marker hình tam giác khi điều hướng - Fixed
        function addTriangleMarker() {
            const el = document.createElement('div');
            el.className = 'nav-triangle-marker';
            el.style.transform = `rotate(${userBearing}deg)`;

            currentLocationMarker = new mapboxgl.Marker({
                element: el,
                anchor: 'center',
                rotation: userBearing
            })
            .setLngLat(currentLocation)
            .addTo(map);
        }

        // Cập nhật hướng cho marker tam giác
        function updateTriangleMarkerRotation() {
            if (!currentLocationMarker || !navigationStarted) return;
            
            const markerEl = currentLocationMarker.getElement();
            markerEl.style.transform = `rotate(${userBearing}deg)`;
        }

        // Add destination marker
        function addDestinationMarker() {
            if (!destination) return;

            if (destinationMarker) {
                destinationMarker.remove();
            }

            destinationMarker = new mapboxgl.Marker({ color: '#f59e0b' })
                .setLngLat(destination)
                .addTo(map);
        }

        // Search functionality
        function toggleSearch() {
            const searchBar = document.getElementById('navSearchBar');
            const searchPanel = document.getElementById('navSearchPanel');
            const searchInput = document.getElementById('navSearchInput');
            
            if (searchPanel.classList.contains('nav-hidden')) {
                searchBar.classList.add('nav-hidden');
                searchPanel.classList.remove('nav-hidden');
                searchInput.focus();
            } else {
                searchBar.classList.remove('nav-hidden');
                searchPanel.classList.add('nav-hidden');
                searchInput.value = '';
            }
        }

        async function searchDestination() {
            const query = document.getElementById('navSearchInput').value.trim();
            if (!query) return;

            showLoading();
            
            try {
                const response = await fetch(
                    `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${mapboxgl.accessToken}&limit=5&proximity=${currentLocation ? currentLocation.join(',') : '105.8542,21.0285'}&language=vi`
                );
                
                const data = await response.json();
                
                if (data.features.length === 0) {
                    alert('Không tìm thấy địa chỉ');
                    return;
                }

                if (data.features.length === 1) {
                    selectDestination(data.features[0]);
                } else {
                    showSearchResults(data.features);
                }
            } catch (error) {
                console.error('Search error:', error);
                alert('Lỗi khi tìm kiếm địa chỉ');
            } finally {
                hideLoading();
            }
        }

        function showSearchResults(features) {
            const resultsList = document.getElementById('navResultsList');
            const resultsContainer = document.getElementById('navSearchResults');
            
            resultsList.innerHTML = '';
            
            features.forEach(feature => {
                const item = document.createElement('div');
                item.className = 'nav-result-item';
                item.onclick = () => selectDestination(feature);
                
                item.innerHTML = `
                    <div class="nav-result-name">${feature.text}</div>
                    <div class="nav-result-address">${feature.place_name}</div>
                `;
                
                resultsList.appendChild(item);
            });
            
            resultsContainer.classList.remove('nav-hidden');
        }

        function hideSearchResults() {
            document.getElementById('navSearchResults').classList.add('nav-hidden');
        }

        function selectDestination(feature) {
            destination = feature.center;
            const destinationName = feature.place_name;
            
            document.getElementById('navDestinationName').textContent = destinationName;
            document.getElementById('navSummary').classList.remove('nav-hidden');
            document.getElementById('navStartBtn').classList.remove('nav-hidden');
            
            if (appMode === 'navigation') {
                document.getElementById('navStartBtn').textContent = 'Bắt đầu điều hướng';
                document.getElementById('navStartBtn').onclick = startNavigation;
                document.getElementById('navDeliveryActions').classList.add('nav-hidden');
            } else {
                document.getElementById('navStartBtn').textContent = 'Bắt đầu giao hàng';
                document.getElementById('navStartBtn').onclick = startDelivery;
            }
            
            addDestinationMarker();
            toggleSearch();
            hideSearchResults();
            
            if (currentLocation) {
                const bounds = new mapboxgl.LngLatBounds()
                    .extend(currentLocation)
                    .extend(destination);
                
                map.fitBounds(bounds, {
                    padding: { top: 100, bottom: 100, left: 50, right: 50 }
                });
            }
        }

        // Delivery functions
        function startDelivery() {
            if (!currentLocation || !destination) return;
            
            navigationStarted = true;
            deliveryStarted = true;
            currentStep = 0;
            
            // Update UI
            document.getElementById('navStartBtn').classList.add('nav-hidden');
            document.getElementById('navInfo').classList.remove('nav-hidden');
            document.getElementById('navDeliveryActions').classList.remove('nav-hidden');
            
            // Update status
            updateDeliveryStatus('active', 'Đang giao hàng');
            
            // Ẩn vòng sóng và chuyển sang marker tam giác
            hideWaveCircle();
            addTriangleMarker();
            
            // Thay đổi góc nhìn bản đồ
            map.easeTo({
                center: currentLocation,
                bearing: userBearing,
                pitch: 45,
                zoom: 18,
                duration: 1000
            });
            
            // Show mode indicator briefly
            document.getElementById('modeIndicator').classList.remove('nav-hidden');
            setTimeout(() => {
                document.getElementById('modeIndicator').classList.add('nav-hidden');
            }, 3000);
            
            getRoute();
        }

        function markPickedUp() {
            updateDeliveryStatus('active', 'Đã lấy hàng - Đang giao');
            // You can add additional logic here for pickup confirmation
        }

        function markDelivered() {
            navigationStarted = false;
            deliveryStarted = false;
            
            // Update UI
            document.getElementById('navInfo').classList.add('nav-hidden');
            document.getElementById('navSummary').classList.add('nav-hidden');
            document.getElementById('navDeliveryActions').classList.add('nav-hidden');
            document.getElementById('navInstructionPanel').classList.add('nav-hidden');
            
            // Update status
            updateDeliveryStatus('idle', 'Sẵn sàng giao hàng');
            
            // Reset markers - XÓA HOÀN TOÀN trước khi tạo mới
            if (currentLocationMarker) {
                currentLocationMarker.remove();
                currentLocationMarker = null;
            }
            
            // Xóa vòng sóng trước khi tạo mới
            map.setFeatureState(
                { source: 'wave-circle', id: 1 },
                { show: false }
            );
            
            // Tạo mới marker và vòng sóng
            addCircleMarker();
            updateWaveCircle();
            
            // Reset map view
            map.easeTo({
                pitch: 0,
                bearing: 0,
                zoom: 16,
                duration: 1000
            });
            
            // Clear route
            map.getSource('route').setData({
                type: 'Feature',
                properties: {},
                geometry: { type: 'LineString', coordinates: [] }
            });
            
            // Remove destination marker
            if (destinationMarker) {
                destinationMarker.remove();
                destinationMarker = null;
            }
            
            destination = null;
            routeData = null;
            
            alert('Đã hoàn thành giao hàng!');
        }

        function updateDeliveryStatus(status, text) {
            const statusBadge = document.getElementById('navStatusBadge');
            const statusText = document.getElementById('navStatusText');
            
            statusBadge.className = `nav-status-badge nav-status-${status}`;
            statusText.textContent = text;
        }

        async function getRoute() {
            if (!currentLocation || !destination) return;

            showLoading();
            
            try {
                const response = await fetch(
                    `https://api.mapbox.com/directions/v5/mapbox/driving/${currentLocation.join(',')};${destination.join(',')}?steps=true&geometries=geojson&overview=full&access_token=${mapboxgl.accessToken}`
                );
                
                const data = await response.json();
                
                if (!data.routes || data.routes.length === 0) {
                    alert('Không tìm thấy tuyến đường');
                    return;
                }

                routeData = data.routes[0];
                
                map.getSource('route').setData({
                    type: 'Feature',
                    properties: {},
                    geometry: routeData.geometry
                });

                updateNavigationInfo();
            } catch (error) {
                console.error('Route error:', error);
                alert('Lỗi khi lấy tuyến đường');
            } finally {
                hideLoading();
            }
        }

        function updateNavigationInfo() {
            if (!routeData) return;

            const distance = (routeData.distance / 1000).toFixed(1);
            const duration = Math.round(routeData.duration / 60);
            const arrivalTime = new Date(Date.now() + routeData.duration * 1000);
            
            document.getElementById('navTotalDistance').textContent = distance + ' km';
            document.getElementById('navTotalTime').textContent = duration + ' phút';
            document.getElementById('navArrivalTime').textContent = arrivalTime.toLocaleTimeString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            document.getElementById('navTimeBadge').classList.remove('nav-hidden');
            document.getElementById('navStatsGrid').classList.remove('nav-hidden');

            // Update current step information
            if (routeData.legs[0] && routeData.legs[0].steps && routeData.legs[0].steps[currentStep]) {
                const step = routeData.legs[0].steps[currentStep];
                document.getElementById('navNextDistance').textContent = (step.distance / 1000).toFixed(1) + ' km';
                document.getElementById('navNextStreet').textContent = step.name || 'Đường không tên';
                
                updateDirectionArrow(step.maneuver.modifier || 'straight');
            }
            
            updateProgressBar();
        }

        // Cập nhật mũi tên chỉ hướng
        function updateDirectionArrow(modifier) {
            const arrowEl = document.getElementById('navDirectionIcon');
            let arrowSymbol = '↑';
            
            switch(modifier) {
                case 'left': arrowSymbol = '←'; break;
                case 'right': arrowSymbol = '→'; break;
                case 'sharp left': arrowSymbol = '↙'; break;
                case 'sharp right': arrowSymbol = '↘'; break;
                case 'slight left': arrowSymbol = '↖'; break;
                case 'slight right': arrowSymbol = '↗'; break;
                case 'straight': default: arrowSymbol = '↑'; break;
            }
            
            arrowEl.textContent = arrowSymbol;
        }

        // Cập nhật thanh tiến trình
        function updateProgressBar() {
            if (!routeData || !currentLocation) return;
            
            const totalDistance = routeData.distance;
            const distanceToDestination = calculateDistance(
                currentLocation[1], currentLocation[0],
                destination[1], destination[0]
            );
            const distanceTraveled = totalDistance - distanceToDestination;
            
            const progressPercent = Math.min(Math.max((distanceTraveled / totalDistance) * 100, 0), 100);
            
            document.getElementById('navProgressFill').style.width = progressPercent + '%';
        }

        // Map controls
        function zoomIn() {
            map.zoomIn();
        }

        function zoomOut() {
            map.zoomOut();
        }

        function toggleView() {
            const pitch = map.getPitch();
            map.easeTo({ pitch: pitch === 0 ? 60 : 0 });
        }

        function goToCurrentLocation() {
            if (currentLocation) {
                map.flyTo({
                    center: currentLocation,
                    zoom: 18,
                    pitch: navigationStarted ? 45 : 0,
                    bearing: navigationStarted ? userBearing : 0
                });
            }
        }

        // Update functions
        function updateAccuracy(accuracy) {
            const accuracyEl = document.getElementById('navAccuracy');
            const badgeEl = document.getElementById('navAccuracyBadge');
            
            if (accuracy) {
                badgeEl.textContent = `GPS: ±${Math.round(accuracy)}m`;
                
                if (accuracy > 500) {
                    badgeEl.className = 'nav-accuracy-badge nav-accuracy-poor';
                } else if (accuracy > 100) {
                    badgeEl.className = 'nav-accuracy-badge nav-accuracy-medium';
                } else {
                    badgeEl.className = 'nav-accuracy-badge nav-accuracy-good';
                }
                
                accuracyEl.classList.remove('nav-hidden');
                
                const warningEl = document.getElementById('navWarning');
                if (accuracy > 100 && navigationStarted) {
                    warningEl.classList.remove('nav-hidden');
                } else {
                    warningEl.classList.add('nav-hidden');
                }
            }
        }

        function updateSpeed(speed) {
            document.getElementById('navSpeed').textContent = Math.round(speed);
        }

        // Utility functions
        function showLoading() {
            document.getElementById('navLoading').classList.remove('nav-hidden');
        }

        function hideLoading() {
            document.getElementById('navLoading').classList.add('nav-hidden');
        }

        // Event listeners
        document.getElementById('navSearchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchDestination();
            }
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            
            // Show mode indicator on startup
            setTimeout(() => {
                document.getElementById('modeIndicator').classList.remove('nav-hidden');
                setTimeout(() => {
                    document.getElementById('modeIndicator').classList.add('nav-hidden');
                }, 3000);
            }, 1000);
        });

        // Toggle mode selector panel
        function toggleModePanel() {
            const panel = document.getElementById('modeSelectorPanel');
            if (panel.classList.contains('nav-hidden')) {
                panel.classList.remove('nav-hidden');
            } else {
                panel.classList.add('nav-hidden');
            }
        }

        // Switch between delivery and navigation modes
        function switchMode(mode) {
            if (mode === appMode) {
                toggleModePanel();
                return;
            }
            
            // Reset state
            if (navigationStarted || deliveryStarted) {
                resetNavigation();
            }
            
            appMode = mode;
            
            // Hide all navigation-specific panels
            document.getElementById('navInstructionPanel').classList.add('nav-hidden');
            
            // Update UI
            const deliveryOption = document.getElementById('deliveryModeOption');
            const navigationOption = document.getElementById('navigationModeOption');
            
            // Show mode indicator
            document.getElementById('modeIndicator').classList.remove('nav-hidden');
            
            if (mode === 'delivery') {
                // Update selector panel
                deliveryOption.style.backgroundColor = '#0ea5e9';
                deliveryOption.style.color = 'white';
                navigationOption.style.backgroundColor = '#f1f5f9';
                navigationOption.style.color = '#64748b';
                
                // Update status
                document.getElementById('navStatusBadge').className = 'nav-status-badge nav-status-idle';
                document.getElementById('navStatusText').textContent = 'Sẵn sàng giao hàng';
                
                // Update search labels
                document.querySelector('.nav-search-placeholder').textContent = 'Tìm địa chỉ giao hàng...';
                document.getElementById('navSearchInput').placeholder = 'Nhập địa chỉ giao hàng...';
                document.querySelector('.nav-results-header').textContent = 'Chọn địa chỉ giao hàng:';
                
                // Apply delivery mode theme
                document.body.classList.remove('navigation-mode');
                
                // Update route style if exists
                if (map && map.getLayer('route')) {
                    map.setPaintProperty('route', 'line-color', '#06b6d4');
                    map.setPaintProperty('route-casing', 'line-color', '#0ea5e9');
                }
                
                // Hiển thị thông báo
                alert('Đã chuyển sang chế độ Giao hàng');
                
                // Show mode indicator temporarily
                setTimeout(() => {
                    document.getElementById('modeIndicator').classList.add('nav-hidden');
                }, 3000);
            } else {
                // Update selector panel
                navigationOption.style.backgroundColor = '#4f46e5';
                navigationOption.style.color = 'white';
                deliveryOption.style.backgroundColor = '#f1f5f9';
                deliveryOption.style.color = '#64748b';
                
                // Update status
                document.getElementById('navStatusBadge').className = 'nav-status-badge nav-status-idle';
                document.getElementById('navStatusText').textContent = 'Sẵn sàng điều hướng';
                
                // Update search labels
                document.querySelector('.nav-search-placeholder').textContent = 'Tìm kiếm địa điểm...';
                document.getElementById('navSearchInput').placeholder = 'Nhập địa điểm đến...';
                document.querySelector('.nav-results-header').textContent = 'Chọn địa điểm:';
                
                // Apply navigation mode theme
                document.body.classList.add('navigation-mode');
                
                // Update route style if exists
                if (map && map.getLayer('route')) {
                    map.setPaintProperty('route', 'line-color', '#4f46e5');
                    map.setPaintProperty('route-casing', 'line-color', '#6366f1');
                }
                
                // Hiển thị thông báo
                alert('Đã chuyển sang chế độ Điều hướng');
                
                // Show mode indicator temporarily
                setTimeout(() => {
                    document.getElementById('modeIndicator').classList.add('nav-hidden');
                }, 3000);
            }
            
            toggleModePanel();
        }

        // Reset navigation state
        function resetNavigation() {
            navigationStarted = false;
            deliveryStarted = false;
            
            // Update UI
            document.getElementById('navInfo').classList.add('nav-hidden');
            document.getElementById('navSummary').classList.add('nav-hidden');
            document.getElementById('navDeliveryActions').classList.add('nav-hidden');
            document.getElementById('navInstructionPanel').classList.add('nav-hidden');
            
            // Reset markers - XÓA HOÀN TOÀN
            if (currentLocationMarker) {
                currentLocationMarker.remove();
                currentLocationMarker = null;
            }
            
            // Xóa vòng sóng trước khi tạo mới
            map.setFeatureState(
                { source: 'wave-circle', id: 1 },
                { show: false }
            );
            
            // THÊM SAU KHI ĐÃ XÓA
            addCircleMarker();
            updateWaveCircle();
            
            // Reset map view
            map.easeTo({
                pitch: 0,
                bearing: 0,
                zoom: 16,
                duration: 1000
            });
            
            // Clear route
            map.getSource('route').setData({
                type: 'Feature',
                properties: {},
                geometry: { type: 'LineString', coordinates: [] }
            });
            
            // Remove destination marker
            if (destinationMarker) {
                destinationMarker.remove();
                destinationMarker = null;
            }
            
            destination = null;
            routeData = null;
        }

        // Navigation function - Improved for real navigation mode
        function startNavigation() {
            if (!currentLocation || !destination) return;
            
            navigationStarted = true;
            deliveryStarted = false;
            currentStep = 0;
            nextStepAnnounced = false;
            
            // Update UI
            document.getElementById('navStartBtn').classList.add('nav-hidden');
            document.getElementById('navInfo').classList.add('nav-hidden'); // Hide regular info
            document.getElementById('navSummary').classList.add('nav-hidden'); // Hide summary
            document.getElementById('navInstructionPanel').classList.remove('nav-hidden'); // Show turn-by-turn instructions
            document.getElementById('navDeliveryActions').classList.add('nav-hidden');
            
            // Update status
            updateDeliveryStatus('active', 'Đang điều hướng');
            
            // Ẩn vòng sóng và chuyển sang marker tam giác
            hideWaveCircle();
            addTriangleMarker();
            
            // Thay đổi góc nhìn bản đồ sang chế độ điều hướng 3D
            map.easeTo({
                center: currentLocation,
                bearing: userBearing,
                pitch: 60, // Higher pitch for navigation
                zoom: 18,
                duration: 1000
            });
            
            getRoute().then(() => {
                if (routeData && routeData.legs && routeData.legs[0] && routeData.legs[0].steps) {
                    // Cập nhật hướng dẫn điều hướng bước đầu tiên
                    updateNavigationInstructions();
                    
                    // Announce first instruction
                    if (voiceEnabled && 'speechSynthesis' in window) {
                        const firstStep = routeData.legs[0].steps[0];
                        const instruction = generateVoiceInstruction(firstStep);
                        speakInstruction(instruction);
                    }
                }
            });
        }

        // Cập nhật hướng dẫn điều hướng
        function updateNavigationInstructions() {
            if (!routeData || !routeData.legs || !routeData.legs[0] || !routeData.legs[0].steps) return;
            
            const steps = routeData.legs[0].steps;
            if (currentStep >= steps.length) return;
            
            const currentInstruction = steps[currentStep];
            
            // Tính toán khoảng cách đến điểm rẽ tiếp theo
            let distanceToTurn = 0;
            if (currentLocation && currentInstruction.maneuver && currentInstruction.maneuver.location) {
                distanceToTurn = calculateDistance(
                    currentLocation[1], currentLocation[0],
                    currentInstruction.maneuver.location[1], currentInstruction.maneuver.location[0]
                );
            }
            
            // Cập nhật bảng hướng dẫn
            document.getElementById('navInstructionDistance').textContent = formatDistance(distanceToTurn);
            document.getElementById('navInstructionAction').textContent = getManeuverAction(currentInstruction.maneuver);
            document.getElementById('navInstructionText').textContent = getManeuverDirection(currentInstruction.maneuver);
            document.getElementById('navInstructionStreet').textContent = currentInstruction.name || 'Đường không tên';
            
            // Cập nhật biểu tượng
            document.getElementById('navInstructionIcon').innerHTML = getManeuverIcon(currentInstruction.maneuver);
            
            // Cập nhật hướng dẫn tiếp theo
            if (currentStep < steps.length - 1) {
                const nextInstruction = steps[currentStep + 1];
                document.getElementById('navInstructionNextText').textContent = 
                    `Sau đó ${getManeuverDirection(nextInstruction.maneuver).toLowerCase()} vào ${nextInstruction.name || 'Đường không tên'}`;
            } else {
                document.getElementById('navInstructionNextText').textContent = 'Đến điểm đến';
            }
            
            // Thông báo giọng nói khi gần đến điểm rẽ
            if (voiceEnabled && distanceToTurn < 200 && !nextStepAnnounced) {
                speakInstruction(generateVoiceInstruction(currentInstruction));
                nextStepAnnounced = true;
            }
        }
        
        // Format khoảng cách
        function formatDistance(distance) {
            if (distance < 1000) {
                return Math.round(distance) + 'm';
            } else {
                return (distance / 1000).toFixed(1) + 'km';
            }
        }

        // Lấy hành động dựa vào loại maneuver
        function getManeuverAction(maneuver) {
            if (!maneuver) return 'Tiếp theo';
            
            switch (maneuver.type) {
                case 'arrive': return maneuver.modifier === 'left' ? 'Điểm đến (bên trái)' : maneuver.modifier === 'right' ? 'Điểm đến (bên phải)' : 'Điểm đến';
                case 'depart': return 'Xuất phát';
                case 'roundabout': return 'Vòng xuyến';
                case 'merge': return 'Nhập làn';
                case 'fork': return 'Ngã ba';
                default: return 'Tiếp theo';
            }
        }

        // Lấy hướng rẽ dựa vào modifier
        function getManeuverDirection(maneuver) {
            if (!maneuver || !maneuver.modifier) return 'Đi thẳng';
            
            switch (maneuver.modifier) {
                case 'left': return 'Rẽ trái';
                case 'right': return 'Rẽ phải';
                case 'straight': return 'Đi thẳng';
                case 'slight left': return 'Rẽ nhẹ trái';
                case 'slight right': return 'Rẽ nhẹ phải';
                case 'sharp left': return 'Rẽ gắt trái';
                case 'sharp right': return 'Rẽ gắt phải';
                case 'uturn': return 'Quay đầu';
                default: return 'Đi thẳng';
            }
        }

        // Lấy biểu tượng cho loại rẽ
        function getManeuverIcon(maneuver) {
            if (!maneuver || !maneuver.modifier) {
                return '<path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"/>';
            }
            
            switch (maneuver.modifier) {
                case 'left': 
                    return '<path d="M14 7l-5 5 5 5V7z"/>';
                case 'right':
                    return '<path d="M10 17l5-5-5-5v10z"/>';
                case 'straight':
                    return '<path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"/>';
                case 'slight left':
                    return '<path d="M16.01 11H4v2h12.01v3L20 12l-3.99-4z" transform="rotate(45, 12, 12)"/>';
                case 'slight right':
                    return '<path d="M16.01 11H4v2h12.01v3L20 12l-3.99-4z" transform="rotate(-45, 12, 12)"/>';
                case 'sharp left':
                    return '<path d="M17.59 5.59L7 16.17V7h2V5H5v6h2v-4.59l9.17 9.17L18 14.41z"/>';
                case 'sharp right':
                    return '<path d="M14 17V7h-2V5h4v6h-2v4.59l9.17-9.17L22 14.41 12.83 23.59z" transform="scale(-1, 1) translate(-24, 0)"/>';
                case 'uturn':
                    return '<path d="M7 6v6h11v3l4-4-4-4v3H9V6z" transform="rotate(90, 12, 12)"/>';
                default:
                    return '<path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"/>';
            }
        }

        // Tạo chỉ dẫn giọng nói
        function generateVoiceInstruction(step) {
            if (!step) return '';
            
            const direction = getManeuverDirection(step.maneuver);
            const roadName = step.name || 'đường không tên';
            const distance = step.distance < 1000 
                ? `${Math.round(step.distance)} mét` 
                : `${(step.distance / 1000).toFixed(1)} kilômét`;
            
            if (step.maneuver.type === 'arrive') {
                return `Bạn đã đến điểm đến`;
            }
            
            if (step.maneuver.type === 'depart') {
                return `Bắt đầu hành trình. ${direction} vào ${roadName}`;
            }
            
            return `Trong ${distance}, ${direction.toLowerCase()} vào ${roadName}`;
        }

        // Phát chỉ dẫn giọng nói
        function speakInstruction(text) {
            if (!text || !voiceEnabled) return;
            
            // Sử dụng Web Speech API nếu được hỗ trợ
            if ('speechSynthesis' in window) {
                const speech = new SpeechSynthesisUtterance(text);
                speech.lang = 'vi-VN';
                window.speechSynthesis.speak(speech);
            }
        }

        // Check step progress - enhanced for navigation mode
        function checkStepProgress() {
            if (!routeData || !routeData.legs[0] || !routeData.legs[0].steps) return;
            
            const steps = routeData.legs[0].steps;
            if (currentStep >= steps.length - 1) return; // Đã ở bước cuối hoặc đã đến
            
            const nextStep = steps[currentStep + 1];
            if (!nextStep.maneuver || !nextStep.maneuver.location) return;
            
            const distanceToNextStep = calculateDistance(
                currentLocation[1], currentLocation[0],
                nextStep.maneuver.location[1], nextStep.maneuver.location[0]
            );
            
            // Nếu trong khoảng 20m đến điểm rẽ tiếp theo, chuyển sang bước tiếp theo
            if (distanceToNextStep < 20) {
                currentStep++;
                nextStepAnnounced = false;
                updateNavigationInstructions();
                
                // Nếu đã đến điểm đến
                if (currentStep === steps.length - 1 && steps[currentStep].maneuver.type === 'arrive') {
                    speakInstruction('Bạn đã đến điểm đến');
                    
                    // Nếu ở chế độ giao hàng và đã đến nơi, hiển thị nút đánh dấu đã giao
                    if (appMode === 'delivery') {
                        document.getElementById('navDeliveryActions').classList.remove('nav-hidden');
                    }
                }
            }
            
            // Trong chế độ điều hướng, cập nhật hướng dẫn liên tục
            if (navigationStarted && !deliveryStarted) {
                updateNavigationInstructions();
            }
        }

        // Update location
        function updateLocation(position) {
            const prevLocation = currentLocation ? [...currentLocation] : null;
            currentLocation = [position.coords.longitude, position.coords.latitude];
            updateAccuracy(position.coords.accuracy);
            
            if (position.coords.speed) {
                lastSpeed = position.coords.speed * 3.6; // m/s to km/h
                updateSpeed(lastSpeed);
            }

            // Cập nhật hướng di chuyển
            if (position.coords.heading) {
                userBearing = position.coords.heading;
            } else if (prevLocation && lastSpeed > 1) {
                userBearing = calculateBearing(
                    prevLocation[1], prevLocation[0],
                    position.coords.latitude, position.coords.longitude
                );
            }

            if (currentLocationMarker) {
                currentLocationMarker.setLngLat(currentLocation);
                
                // Cập nhật hướng cho marker tam giác
                if (navigationStarted) {
                    updateTriangleMarkerRotation();
                }
            }

            // Cập nhật vòng sóng
            updateWaveCircle();

            if (navigationStarted) {
                // Trong chế độ điều hướng thông thường, bản đồ luôn xoay theo hướng di chuyển
                if (!deliveryStarted && appMode === 'navigation') {
                    map.easeTo({
                        center: currentLocation,
                        bearing: userBearing,
                        duration: 300,
                        pitch: 60
                    });
                } else {
                    // Trong chế độ giao hàng, góc nhìn thấp hơn
                    map.easeTo({
                        center: currentLocation,
                        bearing: userBearing,
                        duration: 300,
                        pitch: 45
                    });
                }
                
                updateNavigationInfo();
                checkStepProgress();
            }
        }
    </script>
</body>
</html>